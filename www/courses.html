<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="stylesheet" href="/css/basic.css" type="text/css">
        <title>Index</title>
    </head>
    <body>
        <nav class="menu">
            <a class="menu-logo" href="/">
                <img src="/logo/studydou.png"/>
            </a>
            <a class="menu-title" href="/">StudyDou</a>
            <a class="menu-item" href="/login.html">登錄|註冊</a>
            <a class="menu-item" href="/">課程</a>
        </nav>
        <main>
            <h1 style="text-align: center;">課程</h1>
            <div class="container tags">
                <a href="/">全部</a>
                <a href="/">語文</a>
                <a href="/">數學</a>
                <a href="/">英語</a>
                <a href="/">物理</a>
            </div>
            <div class="container gallery">
                <div id="course">
                    <img f-name="Image" f-onclick="Id"/>
                    <header f-name="Title" f-onclick="Id"></header>
                    <summary f-name="Introduction"></summary>
                    <time f-name="Time" style="float: right"></time>
                </div>
            </div>
        </main>
        <a id="goto" class="goto-btn" onclick="window.scrollTo(0, 0);">
            <img src="/icon/down-chevron.png" alt=""/>
        </a>
        <center id="loading"></center>
        <footer></footer>
    </body>
</html>
<script src="/js/functions.js" charset="utf-8"></script>
<script charset="utf-8">
// type CourseSummary struct {
//     Id int
//     Time int64
//     Title string
//     Introduction string
//     Image string
//     Level int
// }

const size = 4;
var nodes = select_template('#course');
var page = 0;

async function load_more(page, size) {
    set_loading('#loading');
    var data = await load_courses(page, size);
    del_loading('#loading');
    extend_items(data.Courses, nodes.tpl, nodes.ptr, function(id) {
        location.href = `/course.html?id=${id}`;
    });
    return data;
}

function change_gotobtn() {
    var navbar = document.querySelector('nav');
    var bottom = navbar.getBoundingClientRect().bottom;
    if (bottom < 0) {
        document.querySelector('#goto').style.visibility = 'visible';
    } else {
        document.querySelector('#goto').style.visibility = 'hidden';
    }
}

window.onscroll = async function() {
    change_gotobtn();
    var tag = document.querySelector('footer');
    var top = tag.getBoundingClientRect().top;
    if (top < window.innerHeight) {
        const onscroll = window.onscroll;
        window.onscroll = change_gotobtn;
        const data = await load_more(page++, size);
        if (page < data.Total) {
            window.onscroll = onscroll;
        }
    }
}

window.onload = async function() {
    var main = document.querySelector("main");
    var footer = document.querySelector("footer");
    const main_top = main.getBoundingClientRect().top;
    const footer_height = footer.getBoundingClientRect().height;
    main.style.minHeight = window.innerHeight - main_top - footer_height + 'px';

    var tag = document.querySelector('footer');
    var top = tag.getBoundingClientRect().top;
    while (top < window.innerHeight) {
        const data = await load_more(page++, size);
        top = tag.getBoundingClientRect().top;
        if (page >= data.Total) {
            break;
        }
    }
};
</script>
